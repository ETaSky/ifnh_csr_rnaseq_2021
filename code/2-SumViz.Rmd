y---
title: "2- Summarize and Visualize feature count"
output: html_document
---

```{r renv_setup, include = TRUE}
#renv::init() # only run once when the project is created.
renv::restore() # run every time when a different computer is used (practically it is Ok to run every time)
#renv::snapshot() # run every time in the end if there are new packages installed (practically it is Ok to run every time in the end)
```
```{r setup, include = TRUE}

knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggrepel)
```


## Preparation
1.Import featureCounts outputs
```{sh}
# header, copy the terminal outputs
sed '2q;d' ../data/featureCounts/featureCounts_out | sed 's/data\/mapped_STAR\/Aligned.out.bam://g'
```
```{r}
avg_fragment_len = 294 # this is from STAR output, for PE150
# Import feature count outputs
ft_0 <- read.table("../data/featureCounts/featureCounts_out", header = T, sep = "\t", check.names = F)
colnames(ft_0) <- colnames(ft_0) %>% gsub("data\\/mapped_STAR\\/Aligned\\.out\\.bam\\:CSR2019-", "CSR2019\\.", .)

```

2. Import metadata
```{r}
mt_raw <- read.table("../data/Metadata_RNAseq_06072021-jw.txt", header = T, sep = "\t")

# metadata integrity check
sample_id = mt_raw %>% filter(Updates=="RNASeqFinished") %>% pull(TubeID)
intersect(sample_id, colnames(ft_0)) %>% length

mt_0 <- mt_raw %>% filter(Updates=="RNASeqFinished")
```

3. Gene annotation
```{sh}
# Entrez gene ids
wget -P data/reference/ http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M27/gencode.vM27.metadata.EntrezGene.gz
# Gene symbol
wget -P data/reference/ http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_mouse/release_M27/gencode.vM27.metadata.MGI.gz

gunzip ../data/reference/gencode.vM27.metadata.MGI.gz
gunzip ../data/reference/gencode.vM27.metadata.EntrezGene.gz

```
```{r}
gene_entrez = read.delim("../data/reference/gencode.vM27.metadata.EntrezGene", header = F)
gene_symbol = read.delim("../data/reference/gencode.vM27.metadata.MGI", header = F)
gene_tbl = merge(gene_entrez, gene_symbol, by = 1)
head(gene_tbl)
colnames(gene_tbl) = c("Geneid", "entrezid", "gene.symbol", "MGI")
gene_tbl = gene_tbl %>% filter(Geneid %in% ft_0$Geneid)
```

9. Misc
```{r}
BM_colors = c("#377EB8", "#4DAF4A", "#E41A1C", "purple")
names(BM_colors) = c("VF", "CSR", "CS", "VD")
```

## Differential analysis

### Jun-2021-proposal
Here we use DESeq2 package and only compare VF and CS
```{r}

library(DESeq2)
library(apeglm)

mt_wk = mt_0 %>% filter(BirthMode %in% c("VF", "CS"))
ft_wk = ft_0 %>% select(1:5, mt_wk$TubeID)

bodysites = c("Ileum", "Liver")

plot_volcano=function(dat){
    g = ggplot(data = dat, aes(x = log2FoldChange, y = -log10(padj))) + 
        geom_point() + 
        #geom_vline(xintercept=c(-1, 1), col="red") + 
        geom_hline(yintercept=-log10(0.1), col="red") + 
        #scale_color_manual(values = c(No="gray70", Yes="red"), name = "differentiated\nexpressed") + 
        labs(x = "Log2 Fold Change", y = "-log10(adjusted pValue)") + 
        theme_minimal()
    g
}

for (ss in bodysites){
    # ss = "Ileum"
    # prepare DESeq2 dataset
    ## metadata, rownames are sample name
    coldata = mt_wk %>% filter(BodySite==ss) %>% select(TubeID, BirthMode, Sex) %>% mutate(across(.col = -1, .fns = factor)) %>% column_to_rownames(var = "TubeID")
    nsamples = nrow(coldata)
    ## count matrix, rownames are gene names, colnames are sample names
    cts = ft_wk %>% select(1, rownames(coldata)) %>% column_to_rownames(var = "Geneid")
    ## DESeq2 dataset
    dds <- DESeqDataSetFromMatrix(countData = cts, colData = coldata, design = ~ BirthMode + Sex)
    dds$BirthMode <- relevel(dds$BirthMode, ref = "VF")
    
    # prefiltering to increase speed and save memory, more strict filtering is automatically applied later
    keep <- rowSums(counts(dds)) >= 10 # genes with at least 10 reads across all samples
    dds <- dds[keep, ]
    
    # running DE analysis
    dds_run <- DESeq(dds)
    res <- results(dds_run, contrast = c("BirthMode", "CS", "VF"))
    
    ## log fold change chrinkage (explanations see https://hbctraining.github.io/DGE_workshop/lessons/05_DGE_DESeq2_analysis2.html#:~:text=Shrunken%20log2%20foldchanges%20(LFC),High%20dispersion%20values)
    resLFC <- lfcShrink(dds_run, coef = "BirthMode_CS_vs_VF", type = "apeglm", res = res)
    resLFC_dat <- resLFC %>% data.frame %>% mutate(padj = ifelse(is.na(padj), 1, padj)) # explanations of NA in padj can be found https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#pvaluesNA and https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#i-want-to-benchmark-deseq2-comparing-to-other-de-tools.
    
    plot_volcano(resLFC_dat)
    

}
```

